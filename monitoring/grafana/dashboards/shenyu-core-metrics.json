{
  "annotations": {
    "list": []
  },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": null,
  "links": [],
  "liveNow": false,
  "panels": [
    {
      "datasource": {"type": "prometheus", "uid": "PBFA97CFB590B2093"},
      "gridPos": {"h": 2, "w": 24, "x": 0, "y": 0},
      "id": 1000,
      "options": {"content": "统一面板：WebClient 连接池 + Hystrix 线程池 + API 指标", "mode": "markdown"},
      "type": "text"
    },
    {
      "datasource": {"type": "prometheus", "uid": "PBFA97CFB590B2093"},
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 2},
      "id": 1001,
      "title": "WebClient 活跃连接/空闲/等待",
      "type": "timeseries",
      "fieldConfig": {"defaults": {"unit": "short", "custom": {"drawStyle": "line", "showPoints": "never"}}, "overrides": []},
      "options": {"legend": {"displayMode": "table", "placement": "bottom", "calcs": ["last", "max"]}, "tooltip": {"mode": "single"}},
      "targets": [
        {"refId": "A", "expr": "sum by (name) (reactor_netty_connection_provider_active_connections{name=~\"$pool\"})", "legendFormat": "活跃连接 - {{name}}"},
        {"refId": "B", "expr": "sum by (name) (reactor_netty_connection_provider_idle_connections{name=~\"$pool\"})", "legendFormat": "空闲连接 - {{name}}"},
        {"refId": "C", "expr": "sum by (name) (reactor_netty_connection_provider_pending_connections{name=~\"$pool\"})", "legendFormat": "等待连接 - {{name}}"}
      ]
    },
    
    {
      "datasource": {
        "type": "prometheus",
        "uid": "PBFA97CFB590B2093"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "vis": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 2,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {"h": 8, "w": 24, "x": 0, "y": 10},
      "id": 1,
      "options": {
        "legend": {
          "calcs": ["last", "max"],
          "displayMode": "table",
          "placement": "bottom"
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "expr": "security_api_calls_total{vendor=~\"$vendor\"}",
          "interval": "",
          "legendFormat": "API调用总数",
          "refId": "A"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "expr": "hystrix_threadpool_completed_tasks{pool=~\"$hpool\"}",
          "interval": "",
          "legendFormat": "线程池完成任务数",
          "refId": "B"
        },
        {
          "datasource": {"type": "prometheus", "uid": "PBFA97CFB590B2093"},
          "expr": "avg by (vendor,operation) (rate(security_api_calls_duration_seconds_sum{vendor=~\"$vendor\"}[1m]) / rate(security_api_calls_duration_seconds_count{vendor=~\"$vendor\"}[1m])) * 1000",
          "interval": "",
          "legendFormat": "平均RT",
          "refId": "C"
        }
      ],
      "title": "安全API调用 & 线程池任务统计",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "PBFA97CFB590B2093"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "vis": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 2,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "yellow",
                "value": 1
              },
              {
                "color": "red",
                "value": 5
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 18},
      "id": 2,
      "options": {
        "legend": {
          "calcs": ["last", "max"],
          "displayMode": "table",
          "placement": "bottom"
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "expr": "hystrix_threadpool_active_threads{pool=\"ContentSecurityPool\"}",
          "interval": "",
          "legendFormat": "活跃线程数",
          "refId": "A"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "expr": "hystrix_threadpool_queue_size{pool=\"ContentSecurityPool\"}",
          "interval": "",
          "legendFormat": "队列长度",
          "refId": "B"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "expr": "hystrix_threadpool_rejected_tasks{pool=\"ContentSecurityPool\"}",
          "interval": "",
          "legendFormat": "拒绝任务数",
          "refId": "C"
        }
      ],
      "title": "Hystrix 线程池实时状态",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "PBFA97CFB590B2093"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "vis": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 2,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "auto",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "reqps"
        },
        "overrides": []
      },
      "gridPos": {"h": 8, "w": 12, "x": 12, "y": 10},
      "id": 3,
      "options": {
        "legend": {
          "calcs": ["last", "max"],
          "displayMode": "table",
          "placement": "bottom"
        },
        "tooltip": {
          "mode": "single",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "expr": "rate(security_api_calls_total{vendor=~\"$vendor\"}[1m])",
          "interval": "",
          "legendFormat": "API调用速率",
          "refId": "A"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "PBFA97CFB590B2093"
          },
          "expr": "rate(hystrix_threadpool_completed_tasks{pool=~\"$hpool\"}[1m])",
          "interval": "",
          "legendFormat": "线程池任务完成速率",
          "refId": "B"
        }
      ],
      "title": "处理速率 (每秒请求数)",
      "type": "timeseries"
    }
  ],
  "refresh": "5s",
  "schemaVersion": 38,
  "style": "dark",
  "tags": [
    "shenyu",
    "security",
    "monitoring"
  ],
  "templating": {
    "list": [
      {"name": "pool", "type": "query", "datasource": {"type": "prometheus", "uid": "PBFA97CFB590B2093"}, "refresh": 2, "hide": 0, "includeAll": true, "multi": true, "query": "label_values(reactor_netty_connection_provider_active_connections, name)", "current": {"text": "All", "value": "$__all"}},
      {"name": "hpool", "type": "query", "datasource": {"type": "prometheus", "uid": "PBFA97CFB590B2093"}, "refresh": 2, "hide": 0, "includeAll": true, "multi": true, "query": "label_values(hystrix_threadpool_active_threads, pool)", "current": {"text": "All", "value": "$__all"}},
      {"name": "vendor", "type": "custom", "query": "shumei,zkrj,watermark", "multi": true, "includeAll": true, "current": {"text": "All", "value": "$__all"}}
    ]
  },
  "time": {
    "from": "now-30m",
    "to": "now"
  },
  "timepicker": {},
  "timezone": "",
  "title": "AI Gateway 核心监控指标",
  "uid": "shenyu-core",
  "version": 1,
  "weekStart": ""
}
